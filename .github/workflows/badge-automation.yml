name: Registrar Badges e Criar Certificados

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  process-badge:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ§° Instalar Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm install svg-builder@0.0.3

      - name: ğŸ“ Criar script de automaÃ§Ã£o
        run: |
          cat << 'EOF' > process.js
          const fs = require('fs');
          const builder = require('svg-builder');

          // Garantir estrutura inicial do badges.json
          function loadBadges() {
            try {
              const raw = fs.readFileSync('badges.json', 'utf8').trim();

              if (!raw) throw new Error("Empty file");

              return JSON.parse(raw);

            } catch (err) {
              // Se der erro ou estiver vazio â†’ recria o JSON
              const defaultData = {
                mestreDaDocumentacao: [],
                devApoiaDev: []
              };

              fs.writeFileSync('badges.json', JSON.stringify(defaultData, null, 2));
              return defaultData;
            }
          }

          const badgeType = process.env.BADGE_TYPE;
          const githubUser = process.env.PR_USER;
          const repository = process.env.REPO_URL;
          const name = githubUser;
          const date = new Date().toISOString().split('T')[0];

          // Carregar JSON seguro
          const badges = loadBadges();

          // Atualizar JSON com o novo registro
          if (badgeType === "mestre") {
            badges.mestreDaDocumentacao.push({
              githubUser, name, repository, date
            });
          } else {
            badges.devApoiaDev.push({
              githubUser, name, date
            });
          }

          fs.writeFileSync('badges.json', JSON.stringify(badges, null, 2));

          // Criar badge SVG
          const svg = builder
            .width(420)
            .height(100)
            .rect({ width: 420, height: 100, fill: "#1e1e1e", rx: 12 })
            .text({
              x: 210,
              y: 55,
              "text-anchor": "middle",
              fill: "white",
              "font-size": 20
            }, badgeType === "mestre" ? "Mestre da DocumentaÃ§Ã£o" : "Dev que Apoia Dev")
            .render();

          fs.writeFileSync(`badges/${githubUser}-${badgeType}.svg`, svg);

          // Criar certificado individual
          const tplPath =
            badgeType === "mestre"
              ? "templates/MestreDaDocumentacao.md"
              : "templates/DevApoiaDev.md";

          let template = fs.readFileSync(tplPath, "utf8");

          template = template
            .replace(/{{githubUser}}/g, githubUser)
            .replace(/{{name}}/g, name)
            .replace(/{{repository}}/g, repository)
            .replace(/{{date}}/g, date);

          const certFilename =
            badgeType === "mestre"
              ? `certificados/${githubUser}-MestreDaDocumentacao.md`
              : `certificados/${githubUser}-DevApoiaDev.md`;

          fs.writeFileSync(certFilename, template);

          EOF

      - name: ğŸ§  Identificar tipo de badge pela branch
        run: |
          if [[ "${GITHUB_HEAD_REF}" == *"mestre"* ]]; then
            echo "BADGE_TYPE=mestre" >> $GITHUB_ENV
          else
            echo "BADGE_TYPE=apoia" >> $GITHUB_ENV
          fi

      - name: ğŸš€ Executar automaÃ§Ã£o
        env:
          PR_USER: ${{ github.actor }}
          BADGE_TYPE: ${{ env.BADGE_TYPE }}
          REPO_URL: ${{ github.event.pull_request.head.repo.html_url }}
        run: node process.js

      - name: ğŸ’¾ Commit automÃ¡tico
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add badges.json badges/ certificados/
          git commit -m "Certificado e badge criados para ${{ github.actor }}" || echo "Nada para commit"
          git push

      - name: ğŸ” AutoMerge PR
        uses: pascalgn/automerge-action@v0.16.3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
